---
import siteConfig from '../../data/siteConfig.json'

const { title, subtitle, columns } = siteConfig.sections.gallery || { title: 'Gallery', subtitle: 'Photo gallery', columns: { variant: 3, items: [] } };
const sectionName = 'gallery';

// Randomize gallery items
const shuffleArray = (array) => {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
};

const randomizedItems = columns?.randomize ? shuffleArray(columns.items).slice(0, 9) : columns.items.slice(0, 9);

const sectionClass = `section-${sectionName}`;
const itemClass = `${sectionName}-item`;
const imageClass = `${sectionName}-image`;
const captionClass = `${sectionName}-caption`;
---

<section id="gallery" class={`${sectionClass} bg-stone-50 py-20 md:py-20`} aria-labelledby="gallery-heading">
  <div class="max-w-7xl mx-auto px-6 md:px-12">
    
    <div class="text-center mb-12">
      <h2 id="gallery-heading" class="text-xl md:text-2xl font-bold text-slate-900 mb-4 font-heading">
        {title.toUpperCase()}
      </h2>
    </div>
    <div class="text-center mb-12 md:mb-16">
      <p class="text-2xl md:text-3xl text-slate-700 max-w-3xl mx-auto">
        {subtitle.toUpperCase()}
      </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-6 mb-20" role="list" aria-label="Photo gallery of driving lessons and student success stories">
      {randomizedItems?.map((item, index) => (
        <article class={`${itemClass} group`} role="listitem" aria-labelledby={`gallery-${index + 1}-caption`}>
          <div class="relative overflow-hidden bg-white shadow-lg hover:shadow-xl transition-shadow duration-300 cursor-pointer" data-lightbox-trigger data-image={item.image} data-alt={item.alt} data-caption={item.caption} data-index={index}>
            <div class="absolute inset-0 flex items-center justify-center bg-stone-100 gallery-spinner">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-amber-700"></div>
            </div>
            <img 
              src={item.image} 
              alt={item.alt}
              class={`${imageClass} w-full h-[300px] object-cover opacity-0 transition-opacity duration-300`}
              loading="lazy"
              role="img"
              onload="this.style.opacity='1'; this.parentElement.querySelector('.gallery-spinner').style.display='none';"
            />
            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-4 z-10">
              <h3 id={`gallery-${index + 1}-caption`} class={`${captionClass} text-white font-semibold text-lg font-heading`}>
                {item.caption}
              </h3>
            </div>
          </div>
        </article>
      ))}
    </div>
  </div>

  <div id="lightbox" class="fixed inset-0 z-50 hidden items-center justify-center backdrop-blur-sm bg-black/80 transition-all duration-300 opacity-0" role="dialog" aria-modal="true" aria-labelledby="lightbox-caption">
    <div class="relative w-full h-full md:w-auto md:h-auto md:max-w-4xl md:max-h-[90vh] md:mx-4">
    <button id="lightbox-close" class="fixed top-4 right-4 w-12 h-12 bg-slate-600/80 hover:bg-slate-700/90 text-white hover:text-stone-300 transition-colors z-20 flex items-center justify-center" aria-label="Close lightbox">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      
    <button id="lightbox-prev" class="fixed left-4 top-1/2 -translate-y-1/2 w-12 h-12 bg-slate-600/80 hover:bg-slate-700/90 text-white hover:text-stone-300 transition-colors z-20 flex items-center justify-center" aria-label="Previous image">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
    </button>
    <button id="lightbox-next" class="fixed right-4 top-1/2 -translate-y-1/2 w-12 h-12 bg-slate-600/80 hover:bg-slate-700/90 text-white hover:text-stone-300 transition-colors z-20 flex items-center justify-center" aria-label="Next image">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
      </svg>
    </button>
      
      <div class="bg-white shadow-2xl overflow-hidden transform transition-transform duration-300 w-full h-full md:w-auto md:h-auto md:scale-95">
        <img id="lightbox-image" class="w-full h-full md:w-full md:h-auto md:max-h-[85vh] object-cover md:object-contain transition-opacity duration-200" alt="" />
        <div class="absolute bottom-0 left-0 right-0 p-4 bg-stone-50 md:relative">
          <h3 id="lightbox-caption" class="text-lg font-semibold text-slate-900 font-heading"></h3>
        </div>
      </div>
    </div>
  </div>
</section>

<script src="/src/scripts/lightbox.js" type="module" defer></script>